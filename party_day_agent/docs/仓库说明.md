# 主题党日智能体仓库说明

## 1. 仓库概述

本文档详细描述了主题党日活动智能助手项目的代码仓库结构、文件说明和使用指南。本项目基于LangGraph和FastMCP 2.0构建，实现了一个多智能体协作系统，用于自动化、智能化地规划和管理主题党日活动。

## 2. 目录结构

项目采用清晰的模块化结构设计，主要分为主智能体(Planner)和工具智能体(Tools)两大部分。主智能体负责协调整个工作流，工具智能体负责提供特定的功能服务。

```
/opt/hackathon_aiqtoolkit/party_day_agent/
├── party-agent/                    # 主项目目录
│   ├── planner.py                  # 主智能体实现（LangGraph工作流）
│   ├── frontend.html               # 前端界面实现
│   ├── requirements.txt            # 项目依赖列表
│   ├── .env                        # 环境变量配置文件
│   ├── .gitignore                  # Git忽略文件配置
│   ├── README.md                   # 项目说明文档
│   └── tools/                      # 工具智能体目录
│       ├── __init__.py             # 工具包初始化文件
│       ├── venue_mcp.py            # 场地检索工具智能体
│       ├── calendar_mcp.py         # 日历检查工具智能体
│       ├── notify_mcp.py           # 通知发送工具智能体
│       └── summary_mcp.py          # 总结生成工具智能体
├── docker-compose.yml              # Docker容器编排配置
├── Dockerfile.planner              # Planner服务Docker镜像构建文件
├── Dockerfile.tools                # 工具服务Docker镜像构建文件
└── docs/                           # 项目文档目录
    ├── 项目立项书.md                # 项目立项文档
    ├── 核心智能体功能实现说明书.md      # 智能体功能实现说明
    ├── 技术架构设计说明书.md          # 系统架构设计文档
    ├── 多智能体协作机制.md            # 智能体协作机制文档
    ├── MCP协议集成&测试报告.md         # MCP协议测试报告
    ├── 系统集成&功能测试用例.md        # 系统测试用例
    ├── 性能优化&Bug修复记录.md        # 性能优化和Bug修复记录
    ├── 技术文档清单.md                # 项目文档清单
    ├── 详细PRD和MCP接口定义.md        # 产品需求和接口定义
    └── 仓库说明.md                   # 仓库结构说明文档
```

## 3. 核心文件说明

### 3.1 planner.py

**功能描述**：主智能体的核心实现文件，负责构建和执行基于LangGraph的工作流，协调整个活动方案生成过程。

**主要组件**：
- `PartyDayState`：工作流状态定义类
- `build_workflow()`：构建LangGraph工作流函数
- `plan_node()`：制定活动初步计划的节点函数
- `search_venue_node()`：调用场地检索工具的节点函数
- `check_calendar_node()`：调用日历检查工具的节点函数
- `send_notification_node()`：调用通知发送工具的节点函数
- `generate_summary_node()`：调用总结生成工具的节点函数
- `AgentInput`：API请求参数模型
- FastAPI应用实例和路由定义

**关键接口**：
- `/run`：主服务API接口，接收活动需求，返回活动方案

### 3.2 frontend.html

**功能描述**：系统的前端界面实现文件，提供用户交互界面。

**主要组件**：
- HTML结构：页面布局和元素
- CSS样式：使用Tailwind CSS实现界面样式
- JavaScript逻辑：
  - 表单验证和提交
  - API调用
  - 结果展示
  - 模拟数据生成
  - 错误处理

**关键功能**：
- 活动信息输入表单
- 状态显示和进度反馈
- 活动方案结果展示
- API调用错误处理和降级显示

### 3.3 tools/venue_mcp.py

**功能描述**：场地检索工具智能体的实现文件，负责根据地理位置、活动主题和参与人数搜索合适的活动场地。

**主要组件**：
- FastAPI应用实例
- `/call`接口：工具调用入口
- `search_venue()`：场地搜索函数
- 高德地图API集成逻辑
- 模拟数据生成函数

**关键接口**：
- `search_venue`工具接口：接收场地搜索参数，返回场地列表

### 3.4 tools/calendar_mcp.py

**功能描述**：日历检查工具智能体的实现文件，负责检查指定日期是否与参与成员的日程安排存在冲突。

**主要组件**：
- FastAPI应用实例
- `/call`接口：工具调用入口
- `check_calendar()`：日历冲突检查函数
- ICS日历文件解析逻辑
- 日期冲突检测算法
- 模拟数据生成函数

**关键接口**：
- `check_calendar`工具接口：接收日历检查参数，返回冲突检测结果

### 3.5 tools/notify_mcp.py

**功能描述**：通知发送工具智能体的实现文件，负责将生成的活动方案通过企业微信机器人发送给参与成员。

**主要组件**：
- FastAPI应用实例
- `/call`接口：工具调用入口
- `send_notification()`：通知发送函数
- 企业微信机器人API集成逻辑
- 邮件发送功能（可选）
- 通知内容本地存储功能

**关键接口**：
- `send_notification`工具接口：接收通知参数，返回通知发送状态

### 3.6 tools/summary_mcp.py

**功能描述**：总结生成工具智能体的实现文件，负责生成活动总结报告，支持Word文档格式。

**主要组件**：
- FastAPI应用实例
- `/call`接口：工具调用入口
- `generate_summary()`：总结生成函数
- python-docx库集成逻辑
- 文档模板管理
- 文档生成和保存功能

**关键接口**：
- `generate_summary`工具接口：接收总结生成参数，返回总结生成结果

### 3.7 docker-compose.yml

**功能描述**：Docker容器编排配置文件，定义了系统中所有服务的容器配置。

**主要组件**：
- Planner服务配置
- 场地检索服务配置
- 日历检查服务配置
- 通知发送服务配置
- 总结生成服务配置
- 网络配置
- 环境变量配置
- 卷挂载配置

**关键参数**：
- 服务名称和镜像
- 端口映射
- 环境变量
- 依赖关系
- 资源限制

### 3.8 requirements.txt

**功能描述**：项目依赖列表文件，记录了项目所需的Python包及其版本。

**主要依赖**：
- langgraph：用于构建智能体工作流
- fastapi：用于构建Web API
- uvicorn：ASGI服务器
- httpx：异步HTTP客户端
- python-docx：用于生成Word文档
- ics：用于解析ICS日历文件
- ollama：大语言模型集成
- pydantic：数据验证
- python-dotenv：环境变量管理

## 4. 开发环境搭建

### 4.1 环境要求

- Python 3.10或更高版本
- Docker 24.0或更高版本
- Git
- 文本编辑器或IDE（推荐VSCode）

### 4.2 本地开发环境搭建步骤

1. **克隆代码仓库**

```bash
git clone <仓库地址>
cd /opt/hackathon_aiqtoolkit/party_day_agent
```

2. **创建虚拟环境**

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
venv\Scripts\activate     # Windows
```

3. **安装依赖**

```bash
pip install -r party-agent/requirements.txt
```

4. **配置环境变量**

创建`.env`文件，添加以下环境变量：

```
GAODE_KEY=your_gaode_api_key
WX_ROBOT_URL=your_wechat_robot_url
DOCX_TEMPLATE=./template.docx
MCP_URL=http://localhost:8000
CALENDAR_DIR=./calendars
```

5. **启动服务**

启动主智能体服务：

```bash
cd party-agent
python planner.py
```

启动工具智能体服务（需要在不同的终端中执行）：

```bash
# 场地检索服务
python -m tools.venue_mcp

# 日历检查服务
python -m tools.calendar_mcp

# 通知发送服务
python -m tools.notify_mcp

# 总结生成服务
python -m tools.summary_mcp
```

启动前端HTTP服务器：

```bash
python -m http.server 8080 --directory /opt/hackathon_aiqtoolkit/party_day_agent/party-agent
```

## 5. Docker容器化部署

### 5.1 使用docker-compose部署

1. **配置环境变量**

创建`.env`文件，添加所需的环境变量。

2. **启动所有服务**

```bash
docker-compose up -d
```

3. **查看服务状态**

```bash
docker-compose ps
```

4. **查看服务日志**

```bash
docker-compose logs -f <service_name>
```

5. **停止服务**

```bash
docker-compose down
```

### 5.2 单个服务部署

如果需要单独部署某个服务，可以使用Docker命令：

```bash
# 构建镜像
docker build -t party-day-agent-planner -f Dockerfile.planner .

# 运行容器
docker run -d -p 8000:8000 --env-file .env party-day-agent-planner
```

## 6. 开发工作流

### 6.1 代码提交流程

1. **更新代码**

```bash
git pull origin main
```

2. **创建分支**

```bash
git checkout -b feature/your-feature-name
```

3. **编写代码**

4. **提交代码**

```bash
git add .
git commit -m "描述你的更改"
```

5. **推送到远程仓库**

```bash
git push origin feature/your-feature-name
```

6. **创建Pull Request**

### 6.2 代码审查流程

1. 创建Pull Request后，邀请团队成员进行代码审查
2. 代码审查通过后，合并到主分支
3. 删除特性分支

## 7. 测试指南

### 7.1 单元测试

使用pytest进行单元测试：

```bash
cd party-agent
pytest tests/unit/
```

### 7.2 集成测试

```bash
cd party-agent
pytest tests/integration/
```

### 7.3 API测试

可以使用curl、Postman等工具测试API接口：

```bash
curl -X POST http://localhost:8000/run -H "Content-Type: application/json" -d '{"theme": "学习贯彻党的二十大精神", "date": "2023-12-01", "location": "北京市海淀区", "headcount": 30}'
```

## 8. 常见问题与解决方案

### 8.1 API调用失败

**问题描述**：调用外部API（如高德地图API）失败。

**解决方案**：
1. 检查API密钥是否正确配置
2. 检查网络连接是否正常
3. 查看系统是否自动返回了模拟数据

### 8.2 Docker容器启动失败

**问题描述**：Docker容器无法正常启动。

**解决方案**：
1. 查看容器日志，分析失败原因
2. 检查环境变量配置是否正确
3. 检查端口是否被占用
4. 检查依赖服务是否正常启动

### 8.3 内存占用过高

**问题描述**：系统运行一段时间后内存占用过高。

**解决方案**：
1. 检查是否存在内存泄漏问题
2. 调整Docker容器的资源限制
3. 优化代码，释放不必要的资源

### 8.4 前端界面无法访问

**问题描述**：无法访问前端界面或界面显示异常。

**解决方案**：
1. 检查前端HTTP服务器是否正常运行
2. 检查防火墙设置
3. 尝试使用不同的浏览器访问
4. 清除浏览器缓存

## 9. 文档与资源

### 9.1 项目文档

项目文档存放在`docs/`目录下，包括：
- 项目立项书
- 核心智能体功能实现说明书
- 技术架构设计说明书
- 多智能体协作机制
- MCP协议集成&测试报告
- 系统集成&功能测试用例
- 性能优化&Bug修复记录
- 技术文档清单
- 详细PRD和MCP接口定义
- 仓库说明

### 9.2 外部资源

- [LangGraph官方文档](https://langgraph.ai/docs/)
- [FastAPI官方文档](https://fastapi.tiangolo.com/)
- [Docker官方文档](https://docs.docker.com/)
- [高德地图API文档](https://lbs.amap.com/)
- [企业微信机器人开发文档](https://work.weixin.qq.com/api/doc/90000/90136/91770)

## 10. 贡献指南

### 10.1 贡献流程

1. Fork代码仓库
2. 创建特性分支
3. 提交代码更改
4. 运行测试确保代码质量
5. 创建Pull Request
6. 参与代码审查
7. 代码合并到主分支

### 10.2 代码规范

- 遵循Python PEP 8编码规范
- 使用类型注解
- 添加适当的注释和文档字符串
- 保持代码简洁明了
- 编写单元测试

---
版本：v1.0.0
创建日期：2025-09-07