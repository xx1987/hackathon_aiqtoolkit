# 主题党日智能体核心智能体功能实现说明书

## 1. 概述

本说明书详细描述了主题党日活动智能助手的核心智能体功能实现，包括智能体的整体架构、工作流程、各模块功能实现以及关键技术点。本智能体系统基于NVIDIA NeMo Agent Toolkit和FastMCP 2.0 + LangGraph构建，旨在实现主题党日活动的全流程自动化管理。

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────┐
│    前端界面        │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│     Planner服务     │
└──────────┬──────────┘
           │
┌──────────┴──────────┐
│  FastMCP 2.0通信层  │
└──────────┬──────────┘
     ┌─────┴──────┬───────┴───────┬──────────┴───────┐
┌────▼─────┐ ┌────▼─────┐ ┌───────▼─────┐ ┌──────────▼─────┐
│场地检索服务│ │日历检查服务│ │通知发送服务│ │ 总结生成服务  │
└──────────┘ └──────────┘ └────────────┘ └───────────────┘
```

### 2.2 智能体组成

1. **Planner服务**：主智能体，负责协调整个工作流，基于LangGraph构建
2. **场地检索服务**：搜索合适的活动场地，集成高德地图API
3. **日历检查服务**：检查日历冲突，支持ICS文件解析
4. **通知发送服务**：发送活动通知，支持企业微信机器人
5. **总结生成服务**：生成活动总结报告，支持Word文档生成

## 3. 主智能体（Planner）功能实现

### 3.1 功能概述

Planner是系统的核心智能体，负责协调整个工作流，根据用户输入的活动信息，调用各个工具智能体完成相应的任务，并最终生成完整的活动方案。

### 3.2 工作流设计

Planner基于LangGraph构建了一个完整的工作流，包含以下节点：

1. **search_venues**：场地检索节点
2. **check_calendar**：日历冲突检测节点
3. **generate_plan**：方案生成节点
4. **send_notification**：通知发送节点
5. **generate_summary**：总结生成节点

工作流执行流程如下：
- 首先调用场地检索服务，获取合适的活动场地
- 然后检查日历冲突，确定合适的活动日期
- 接着生成活动方案
- 发送活动通知给参与人员
- 最后生成活动总结报告

### 3.3 核心代码实现

```python
# 构建LangGraph工作流
def build_workflow():
    """Build the LangGraph workflow"""
    # Create StateGraph
    workflow = StateGraph(PartyDayState)
    
    # Add nodes to the graph
    workflow.add_node("search_venues", search_venues)
    workflow.add_node("check_calendar", check_calendar)
    workflow.add_node("generate_plan", generate_plan)
    workflow.add_node("send_notification", send_notification)
    workflow.add_node("generate_summary", generate_summary)
    
    # Define edges between nodes
    workflow.add_edge("search_venues", "check_calendar")
    workflow.add_edge("check_calendar", "generate_plan")
    workflow.add_edge("generate_plan", "send_notification")
    workflow.add_edge("send_notification", "generate_summary")
    workflow.add_edge("generate_summary", WORKFLOW_END_NODE)
    
    # Set entry point
    workflow.set_entry_point("search_venues")
    
    # Compile workflow
    return workflow.compile()
```

### 3.4 错误处理机制

Planner实现了完善的错误处理机制，确保工作流的稳定运行：
1. 每个节点都包含错误处理逻辑，当出现异常时会返回默认的模拟数据
2. 使用try-except捕获所有可能的异常，避免工作流中断
3. 实现降级处理，当外部API调用失败时，提供模拟数据作为备选方案

## 4. 工具智能体功能实现

### 4.1 场地检索服务（venue_service）

#### 4.1.1 功能概述

场地检索服务负责根据用户提供的地理位置、活动主题和参与人数，搜索合适的活动场地。

#### 4.1.2 核心功能
- 基于高德地图API进行场地搜索
- 支持按地理位置、主题和人数筛选
- 实现搜索半径限制
- 提供模拟数据作为备选方案

#### 4.1.3 接口定义

```python
@mcp.tool()
async def search(ctx: Any, theme: str, headcount: int, lat: float, lng: float, radius_km: int = 10) -> List[Dict[str, Any]]:
    """根据主题、人数和位置搜索合适的场地
    
    Args:
        theme: 活动主题
        headcount: 参与人数
        lat: 纬度
        lng: 经度
        radius_km: 搜索半径（公里）
    
    Returns:
        符合条件的场地列表
    """
```

### 4.2 日历检查服务（calendar_service）

#### 4.2.1 功能概述

日历检查服务负责检查指定日期是否与参与成员的日程安排存在冲突。

#### 4.2.2 核心功能
- 解析ICS格式的日历文件
- 检查指定日期是否有日程冲突
- 支持批量检查多个成员的日程
- 实现周末和工作日不同的冲突概率模型

#### 4.2.3 接口定义

```python
@mcp.tool()
async def check(ctx: Any, date: str, member_ids: List[str]) -> Dict[str, Any]:
    """检查指定日期是否有日历冲突
    
    Args:
        date: 要检查的日期（格式：YYYY-MM-DD）
        member_ids: 成员ID列表
    
    Returns:
        是否存在冲突的结果
    """
```

### 4.3 通知发送服务（notify_service）

#### 4.3.1 功能概述

通知发送服务负责将生成的活动方案通过企业微信机器人发送给参与成员。

#### 4.3.2 核心功能
- 支持企业微信机器人Webhook发送通知
- 实现邮件通知功能（可选）
- 将通知内容保存到本地文件
- 提供通知模板定制

#### 4.3.3 接口定义

```python
@mcp.tool()
async def send(ctx: Any, plan: Dict[str, Any]) -> Dict[str, Any]:
    """发送活动通知
    
    Args:
        plan: 活动方案信息
    
    Returns:
        发送结果
    """
```

### 4.4 总结生成服务（summary_service）

#### 4.4.1 功能概述

总结生成服务负责生成活动总结报告，支持Word文档格式。

#### 4.4.2 核心功能
- 基于活动信息生成Word格式的总结报告
- 支持自定义报告模板
- 保存报告文件并提供下载链接

#### 4.4.3 接口定义

```python
@app.tool(
    name="summary.generate",
    description="生成主题党日活动总结文档",
    schema=SUMMARY_GENERATE_SCHEMA
) 
async def generate(request: Dict[str, Any], context: Context) -> Dict[str, Any]:
    """生成主题党日活动总结文档"""
```

## 5. 大语言模型集成

### 5.1 集成方式

系统集成了大语言模型，用于生成活动方案和总结报告。支持两种集成方式：
1. **API调用**：通过API调用外部大语言模型服务（默认使用阿里云DashScope）
2. **本地部署**：支持Ollama本地部署的大语言模型

### 5.2 核心代码实现

```python
class LLMClient:
    async def generate_plan(self, theme, venue, date, headcount):
        # 调用大语言模型生成活动方案
        # 返回生成的方案详情
        return {
            "time": "09:00-11:30",
            "agenda": [
                "09:00-09:15 签到入场",
                "09:15-09:30 开场致辞",
                "09:30-10:30 主题学习",
                "10:30-11:15 交流讨论",
                "11:15-11:30 总结展望"
            ],
            "requirements": "请携带笔记本和笔，提前10分钟到达会场",
            "notes": "请遵守场地规定，保持会场整洁"
        }
```

## 6. Web API接口设计

### 6.1 API端点

Planner服务提供了以下API端点：
- **POST /run**：运行智能体，生成活动方案
- **GET /health**：健康检查接口

### 6.2 请求参数

```python
class AgentInput(BaseModel):
    plan_id: Optional[str] = None
    theme: str = "学习党的二十大精神"
    date: Optional[str] = None
    location: Optional[str] = None
    lat: float = 39.9042
    lng: float = 116.4074
    radius: Optional[float] = None
    headcount: int = 20
    radius_km: float = 10.0
    member_ids: Optional[List[str]] = None
```

### 6.3 响应格式

```json
{
  "plan_id": "plan_xxx",
  "venue": {
    "id": "venue_xxx",
    "name": "党员活动室",
    "address": "北京市海淀区"
  },
  "date": "2023-06-30",
  "notification_sent": true,
  "summary_file_url": "http://localhost:8005/files/summary.docx"
}
```

## 7. 模拟数据机制

为了在开发和测试环境中提供良好的体验，系统实现了完善的模拟数据机制：
1. 所有外部API调用失败时，自动返回模拟数据
2. 依赖库导入失败时，提供模拟的类和方法
3. 在没有真实配置的情况下，仍然可以完整演示系统功能

## 8. 部署与配置

### 8.1 Docker部署

系统支持Docker容器化部署，通过docker-compose一键启动所有服务：

```yaml
services:
  # LangGraph主流程服务
  planner:
    build:
      context: .
      dockerfile: Dockerfile.planner
    ports:
      - "8000:8000"
    environment:
      - MCP_URL=http://localhost:8000
      - GAODE_KEY=${GAODE_KEY}
      - WX_ROBOT_URL=${WX_ROBOT_URL}
      - DOCX_TEMPLATE=./template.docx
    depends_on:
      - venue_service
      - calendar_service
      - notify_service
      - summary_service
    networks:
      - party_agent_network

  # 其他服务配置...
```

### 8.2 环境变量配置

系统支持通过环境变量进行配置：
- **GAODE_KEY**：高德地图Web API密钥
- **WX_ROBOT_URL**：企业微信机器人Webhook URL
- **DOCX_TEMPLATE**：Word模板文件路径
- **MCP_URL**：MCP服务地址

## 9. 性能优化

### 9.1 异步处理

系统采用异步编程模式，使用asyncio和FastAPI实现高性能的异步处理，提高系统吞吐量和响应速度。

### 9.2 缓存机制

对频繁访问的数据和API调用结果实现缓存机制，减少重复计算和API调用次数。

### 9.3 降级处理

当外部服务不可用时，自动切换到降级模式，使用模拟数据提供基础功能，确保系统可用性。

---
版本：v1.0.0
编制日期：2025-09-07