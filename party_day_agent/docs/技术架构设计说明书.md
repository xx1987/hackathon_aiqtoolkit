# 主题党日智能体技术架构设计说明书

## 1. 系统架构概述

主题党日活动智能助手采用基于FastMCP 2.0和LangGraph的多智能体协作架构，实现活动全流程自动化管理。本说明书详细描述了系统的整体架构、技术组件、通信机制和部署方案。

## 2. 整体架构设计

### 2.1 分层架构

系统采用清晰的分层架构设计，包括：

1. **表现层**：提供用户交互界面，基于HTML、CSS和JavaScript实现
2. **API层**：提供RESTful API接口，基于FastAPI构建
3. **业务逻辑层**：实现核心业务逻辑，基于LangGraph构建工作流
4. **工具服务层**：提供各种功能工具，基于FastMCP 2.0实现
5. **数据层**：处理数据存储和访问

### 2.2 组件关系图

```
┌─────────────────────┐
│    前端界面        │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│     FastAPI API     │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│   LangGraph工作流   │
└──────────┬──────────┘
           │
┌──────────▼──────────┐
│  FastMCP 2.0通信层  │
└──────────┬──────────┘
     ┌─────┴──────┬───────┴───────┬──────────┴───────┐
┌────▼─────┐ ┌────▼─────┐ ┌───────▼─────┐ ┌──────────▼─────┐
│场地检索服务│ │日历检查服务│ │通知发送服务│ │ 总结生成服务  │
└────┬────┘ └────┬────┘ └───────┬────┘ └──────────┬────┘
     │           │              │                  │
┌────▼─────┐ ┌────▼─────┐ ┌───────▼─────┐ ┌──────────▼─────┐
│高德地图API│ │  ICS文件 │ │企业微信机器人│ │    docx模板    │
└──────────┘ └──────────┘ └────────────┘ └───────────────┘
```

## 3. 核心组件设计

### 3.1 Planner服务（主智能体）

#### 3.1.1 功能描述

Planner服务是系统的核心智能体，负责协调整个工作流，根据用户输入的活动信息，调用各个工具智能体完成相应的任务，并最终生成完整的活动方案。

#### 3.1.2 技术实现

- 基于LangGraph构建工作流
- 使用FastAPI提供Web API接口
- 采用异步编程模式提高性能
- 实现完善的错误处理和降级机制

#### 3.1.3 关键类和接口

- `PartyDayState`：定义工作流状态
- `build_workflow()`：构建LangGraph工作流
- `run_party_day_agent()`：执行智能体工作流
- `AgentInput`：API请求参数模型

### 3.2 场地检索服务（venue_service）

#### 3.2.1 功能描述

场地检索服务负责根据用户提供的地理位置、活动主题和参与人数，搜索合适的活动场地。

#### 3.2.2 技术实现

- 基于FastMCP 2.0实现
- 集成高德地图API进行场地搜索
- 实现模拟数据生成机制
- 支持按地理位置、主题和人数筛选

#### 3.2.3 关键类和接口

- `search()`：场地搜索工具接口
- `VenueSearchInput`：输入参数模型

### 3.3 日历检查服务（calendar_service）

#### 3.3.1 功能描述

日历检查服务负责检查指定日期是否与参与成员的日程安排存在冲突。

#### 3.3.2 技术实现

- 基于FastMCP 2.0实现
- 支持ICS格式的日历文件解析
- 实现日期冲突检测算法
- 支持模拟日历数据

#### 3.3.3 关键类和接口

- `check()`：日历冲突检查工具接口
- `CalendarCheckInput`：输入参数模型
- `CalendarCheckOutput`：输出结果模型

### 3.4 通知发送服务（notify_service）

#### 3.4.1 功能描述

通知发送服务负责将生成的活动方案通过企业微信机器人发送给参与成员。

#### 3.4.2 技术实现

- 基于FastMCP 2.0实现
- 支持企业微信机器人Webhook
- 实现邮件通知功能（可选）
- 支持通知内容本地存储

#### 3.4.3 关键类和接口

- `send()`：通知发送工具接口
- `NotifyInput`：输入参数模型
- `NotifyOutput`：输出结果模型
- `save_notification_to_file()`：通知内容保存函数

### 3.5 总结生成服务（summary_service）

#### 3.5.1 功能描述

总结生成服务负责生成活动总结报告，支持Word文档格式。

#### 3.5.2 技术实现

- 基于FastMCP 2.0实现
- 使用python-docx库生成Word文档
- 支持自定义报告模板
- 实现文档保存和下载功能

#### 3.5.3 关键类和接口

- `generate()`：总结生成工具接口
- `GenerateSummaryRequest`：输入参数模型
- `GenerateSummaryResponse`：输出结果模型
- `SUMMARY_GENERATE_SCHEMA`：工具调用模式定义

## 4. 通信机制设计

### 4.1 MCP协议通信

系统采用FastMCP 2.0协议实现智能体之间的通信，主要特点包括：

- 基于HTTP/HTTPS协议的RESTful接口
- 支持异步通信模式
- 提供统一的工具调用格式
- 实现错误处理和重试机制

### 4.2 通信流程

1. Planner服务通过HTTP POST请求调用各工具服务
2. 工具服务处理请求并返回结果
3. Planner服务根据返回结果决定下一步操作
4. 所有通信支持JSON格式的数据交换

### 4.3 通信安全

- 支持HTTPS加密通信
- 实现请求验证和权限控制
- 防止SQL注入和XSS攻击
- 对敏感数据进行加密处理

## 5. 数据模型设计

### 5.1 核心数据模型

#### 5.1.1 活动方案（Plan）

```json
{
  "plan_id": "string",
  "theme": "string",
  "date": "string",
  "venue": {
    "id": "string",
    "name": "string",
    "address": "string",
    "capacity": "number",
    "lat": "number",
    "lng": "number"
  },
  "headcount": "number",
  "plan_details": {
    "time": "string",
    "agenda": ["string"],
    "requirements": "string",
    "notes": "string"
  },
  "member_ids": ["string"],
  "notification_sent": "boolean",
  "summary_file_url": "string"
}
```

#### 5.1.2 场地（Venue）

```json
{
  "id": "string",
  "name": "string",
  "address": "string",
  "capacity": "number",
  "lat": "number",
  "lng": "number"
}
```

#### 5.1.3 日历冲突检测结果

```json
{
  "conflict": "boolean",
  "conflicting_events": ["string"]
}
```

## 6. 部署架构设计

### 6.1 Docker容器化部署

系统采用Docker容器化部署，通过docker-compose管理多个服务：

```yaml
services:
  # LangGraph主流程服务
  planner:
    build:
      context: .
      dockerfile: Dockerfile.planner
    ports:
      - "8000:8000"
    environment:
      - MCP_URL=http://localhost:8000
      - GAODE_KEY=${GAODE_KEY}
      - WX_ROBOT_URL=${WX_ROBOT_URL}
      - DOCX_TEMPLATE=./template.docx
    depends_on:
      - venue_service
      - calendar_service
      - notify_service
      - summary_service
    networks:
      - party_agent_network

  # 场地搜索服务
  venue_service:
    build:
      context: .
      dockerfile: Dockerfile.tools
    command: python -m tools.venue_mcp
    ports:
      - "8001:8001"
    environment:
      - GAODE_KEY=${GAODE_KEY}
    volumes:
      - .:/app
    networks:
      - party_agent_network

  # 其他服务配置...
```

### 6.2 网络配置

- 使用Docker网络进行容器间通信
- 服务间通信通过端口映射实现
- 支持自定义网络配置

### 6.3 环境变量配置

系统支持通过环境变量进行配置，主要包括：
- **GAODE_KEY**：高德地图Web API密钥
- **WX_ROBOT_URL**：企业微信机器人Webhook URL
- **DOCX_TEMPLATE**：Word模板文件路径
- **MCP_URL**：MCP服务地址
- **CALENDAR_DIR**：日历文件目录

## 7. 安全架构设计

### 7.1 数据安全

- 对敏感数据进行加密存储
- 实现数据访问权限控制
- 定期进行数据备份
- 防止数据泄露和篡改

### 7.2 接口安全

- 实现API接口鉴权
- 防止接口滥用和攻击
- 支持请求频率限制
- 实现接口日志记录

### 7.3 系统安全

- 采用最小权限原则配置容器权限
- 定期更新系统和依赖库版本
- 实现安全漏洞扫描
- 配置安全日志监控

## 8. 扩展性设计

### 8.1 功能扩展机制

系统设计支持灵活的功能扩展：
- 基于FastMCP 2.0的工具注册机制
- 支持动态加载新的工具服务
- 工作流节点可配置和扩展
- 支持自定义工具和服务集成

### 8.2 性能扩展

- 支持服务横向扩展
- 实现负载均衡机制
- 支持缓存优化
- 采用异步处理提高并发能力

## 9. 监控与维护设计

### 9.1 日志系统

- 实现详细的日志记录
- 支持日志级别配置
- 提供日志聚合和分析功能
- 实现异常告警机制

### 9.2 健康检查

- 提供服务健康检查接口
- 实现自动故障检测和恢复
- 支持服务状态监控
- 定期进行系统健康评估

### 9.3 配置管理

- 实现集中化配置管理
- 支持配置热更新
- 提供配置版本控制
- 实现配置备份和恢复

---
版本：v1.0.0
编制日期：2025-09-07